name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...

  auto-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Get next version
        id: version
        run: |
          # Single source of truth: VERSION file in repo root (e.g. 0.1.16)
          # To cut a minor/major release, update VERSION (e.g. to 0.2.0) before pushing
          VERSION=$(cat VERSION | tr -d '[:space:]')
          if [ -z "$VERSION" ]; then
            echo "::error::VERSION file is empty or missing"
            exit 1
          fi
          NEW_TAG="v${VERSION}"
          # If tag already exists, append date suffix (e.g. v0.2.5-20260220)
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            DATE_SUFFIX=$(date -u +"%Y%m%d%H%M")
            NEW_TAG="v${VERSION}-${DATE_SUFFIX}"
            echo "Tag v${VERSION} already exists, using $NEW_TAG"
          fi
          echo "new=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Using release version: $NEW_TAG"

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.new }}
          git push origin ${{ steps.version.outputs.new }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump VERSION for next release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main
          IFS='.' read -r MAJOR MINOR PATCH <<< "$(cat VERSION | tr -d '[:space:]')"
          NEXT_PATCH=$((PATCH + 1))
          echo "${MAJOR}.${MINOR}.${NEXT_PATCH}" > VERSION
          git add VERSION
          git commit -m "chore: bump VERSION to ${MAJOR}.${MINOR}.${NEXT_PATCH} [skip ci]"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
